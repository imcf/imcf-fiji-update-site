name: "[`UniBas-IMCF-Beta`] Deploy ğŸšš contents â˜• ğŸ”¬ to Update Site"

on:
  push:
    branches: [main]  # Trigger the workflow on push to the main branch
  workflow_dispatch:  # Allow to run this workflow manually from the Actions tab

jobs:

  publish-update-site:

    runs-on: ubuntu-latest
    env:
      IJ_DOWNLOAD_URL: https://downloads.imagej.net/fiji/latest/fiji-linux64.zip
      WIKI_USER: ${{ secrets.UPDATE_SITE_USER }}
      UPDATE_PASS: ${{ secrets.UPDATE_SITE_PASS }}
      UPDATE_SITE: UniBas-IMCF-Beta

    steps:

      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŒ ğŸ“¥ Download Fiji
        run: curl --silent -O ${IJ_DOWNLOAD_URL}

      - name: ğŸ“¦ ğŸˆ Unzip Fiji
        run: unzip fiji-linux64.zip

      - name: ğŸ” Add Fiji update site
        run: |
          ./Fiji.app/ImageJ-linux64 \
              --headless \
              --update \
                  edit-update-site \
                  ${UPDATE_SITE} \
                  https://sites.imagej.net/${UPDATE_SITE}/ \
                  "webdav:${WIKI_USER}:${UPDATE_PASS}" \
                  .

      - name: ğŸ‘· Install scripts and artifacts ğŸ’ğŸ‘‘ into ImageJ/Fiji
        run: bash ./manage/assemble-fiji-components.sh

      - name: ğŸ ğŸ“¤ Release to ImageJ update site
        run: |
          ./Fiji.app/ImageJ-linux64 \
              --headless \
              --update upload-complete-site \
              --force ${UPDATE_SITE}